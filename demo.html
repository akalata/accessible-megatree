<!DOCTYPE html>
<html lang="en">
<head>
    <title>Accessible Megatree demo</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

    <script
            src="https://code.jquery.com/jquery-1.12.4.min.js"
            integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
            crossorigin="anonymous"></script>
    <script>
        // Temporarily embedded while we work on it.
        /*global jQuery */
        (function ($, window, document) {
            "use strict";

            var pluginName = "accessibleMegaMenu",
                defaults = {
                    uuidPrefix: "accessible-megamenu", // unique ID's are required to indicate aria-owns, aria-controls and aria-labelledby
                    menuClass: "accessible-megamenu", // default css class used to define the megamenu styling
                    topNavItemClass: "accessible-megamenu-top-nav-item", // default css class for a top-level navigation item in the megamenu
                    panelClass: "accessible-megamenu-panel", // default css class for a megamenu panel
                    panelGroupClass: "accessible-megamenu-panel-group", // default css class for a group of items within a megamenu panel
                    hoverClass: "hover", // default css class for the hover state
                    focusClass: "focus", // default css class for the focus state
                    openClass: "open", // default css class for the open state
                    openDelay: 0, // default open delay when opening menu via mouseover
                    closeDelay: 250 // default open delay when opening menu via mouseover
                },
                Keyboard = {
                    BACKSPACE: 8,
                    COMMA: 188,
                    DELETE: 46,
                    DOWN: 40,
                    END: 35,
                    ENTER: 13,
                    ESCAPE: 27,
                    HOME: 36,
                    LEFT: 37,
                    PAGE_DOWN: 34,
                    PAGE_UP: 33,
                    PERIOD: 190,
                    RIGHT: 39,
                    SPACE: 32,
                    TAB: 9,
                    UP: 38,
                    keyMap: {
                        48: "0",
                        49: "1",
                        50: "2",
                        51: "3",
                        52: "4",
                        53: "5",
                        54: "6",
                        55: "7",
                        56: "8",
                        57: "9",
                        59: ";",
                        65: "a",
                        66: "b",
                        67: "c",
                        68: "d",
                        69: "e",
                        70: "f",
                        71: "g",
                        72: "h",
                        73: "i",
                        74: "j",
                        75: "k",
                        76: "l",
                        77: "m",
                        78: "n",
                        79: "o",
                        80: "p",
                        81: "q",
                        82: "r",
                        83: "s",
                        84: "t",
                        85: "u",
                        86: "v",
                        87: "w",
                        88: "x",
                        89: "y",
                        90: "z",
                        96: "0",
                        97: "1",
                        98: "2",
                        99: "3",
                        100: "4",
                        101: "5",
                        102: "6",
                        103: "7",
                        104: "8",
                        105: "9",
                        190: "."
                    }
                };
            /**
             * @desc Creates a new accessible mega menu instance.
             * @param {jquery} element
             * @param {object} [options] Mega Menu options
             * @param {string} [options.uuidPrefix=accessible-megamenu] - Prefix for generated unique id attributes, which are required to indicate aria-owns, aria-controls and aria-labelledby
             * @param {string} [options.menuClass=accessible-megamenu] - CSS class used to define the megamenu styling
             * @param {string} [options.topNavItemClass=accessible-megamenu-top-nav-item] - CSS class for a top-level navigation item in the megamenu
             * @param {string} [options.panelClass=accessible-megamenu-panel] - CSS class for a megamenu panel
             * @param {string} [options.panelGroupClass=accessible-megamenu-panel-group] - CSS class for a group of items within a megamenu panel
             * @param {string} [options.hoverClass=hover] - CSS class for the hover state
             * @param {string} [options.focusClass=focus] - CSS class for the focus state
             * @param {string} [options.openClass=open] - CSS class for the open state
             * @constructor
             */
            function AccessibleMegaMenu(element, options) {
                this.element = element;

                // merge optional settings and defaults into settings
                this.settings = $.extend({}, defaults, options);

                this._defaults = defaults;
                this._name = pluginName;

                this.mouseTimeoutID = null;
                this.focusTimeoutID = null;
                this.mouseFocused = false;
                this.justFocused = false;

                this.init();
            }

            AccessibleMegaMenu.prototype = (function () {

                /* private attributes and methods ------------------------ */
                var uuid = 0,
                    keydownTimeoutDuration = 1000,
                    keydownSearchString = "",
                    isTouch = typeof window.hasOwnProperty === "function" && !!window.hasOwnProperty("ontouchstart"),
                    _getPlugin,
                    _addUniqueId,
                    _togglePanel,
                    _clickHandler,
                    _clickOutsideHandler,
                    _DOMAttrModifiedHandler,
                    _focusInHandler,
                    _focusOutHandler,
                    _keyDownHandler,
                    _mouseDownHandler,
                    _mouseOverHandler,
                    _mouseOutHandler,
                    _toggleExpandedEventHandlers;

                /**
                 * @name jQuery.fn.accessibleMegaMenu~_getPlugin
                 * @desc Returns the parent accessibleMegaMenu instance for a given element
                 * @param {jQuery} element
                 * @memberof jQuery.fn.accessibleMegaMenu
                 * @inner
                 * @private
                 */
                _getPlugin = function (element) {
                    return $(element).closest(':data(plugin_' + pluginName + ')').data("plugin_" + pluginName);
                };


                /**
                 * @name jQuery.fn.accessibleMegaMenu~_keyDownHandler
                 * @desc Handle keydown event on mega menu.
                 * @param {event} Event object
                 * @memberof jQuery.fn.accessibleMegaMenu
                 * @inner
                 * @private
                 */
                _keyDownHandler = function (event) {
                console.log(event);
                    var that = (this.constructor === AccessibleMegaMenu) ? this : _getPlugin(this), // determine the AccessibleMegaMenu plugin instance
                        settings = that.settings,
                        target = $($(this).is('.' + settings.hoverClass + ':tabbable') ? this : event.target), // if the element is hovered the target is this, otherwise, its the focused element
                        menu = that.menu,
                        topnavitems = that.topnavitems,
                        topli = target.closest('.' + settings.topNavItemClass),
                        tabbables = menu.find(':tabbable'),
                        panel = target.hasClass(settings.panelClass) ? target : target.closest('.' + settings.panelClass),
                        panelGroups = panel.find('.' + settings.panelGroupClass),
                        currentPanelGroup = target.closest('.' + settings.panelGroupClass),
                        next,
                        keycode = event.keyCode || event.which,
                        start,
                        i,
                        o,
                        label,
                        found = false,
                        newString = Keyboard.keyMap[event.keyCode] || '',
                        regex,
                        isTopNavItem = (topli.length === 1 && panel.length === 0);

                    if (target.is("input:focus, select:focus, textarea:focus, button:focus")) {
                        // if the event target is a form element we should handle keydown normally
                        return;
                    }

                    if (target.is('.' + settings.hoverClass + ':tabbable')) {
                        $('html').off('keydown.accessible-megamenu');
                    }

                    switch (keycode) {
                        case Keyboard.ESCAPE:
                            _togglePanel.call(that, event, true);
                            break;
                        case Keyboard.DOWN:
                            event.preventDefault();
                            if (isTopNavItem) {
                                _togglePanel.call(that, event);
                                found = (topli.find('.' + settings.panelClass + ' :tabbable:first').focus().length === 1);
                            } else {
                                found = (tabbables.filter(':gt(' + tabbables.index(target) + '):first').focus().length === 1);
                            }

                            if (!found && window.opera && opera.toString() === "[object Opera]" && (event.ctrlKey || event.metaKey)) {
                                tabbables = $(':tabbable');
                                i = tabbables.index(target);
                                found = ($(':tabbable:gt(' + $(':tabbable').index(target) + '):first').focus().length === 1);
                            }
                            break;
                        case Keyboard.UP:
                            event.preventDefault();
                            if (isTopNavItem && target.hasClass(settings.openClass)) {
                                _togglePanel.call(that, event, true);
                                next = topnavitems.filter(':lt(' + topnavitems.index(topli) + '):last');
                                if (next.children('.' + settings.panelClass).length) {
                                    found = (next.children()
                                        .attr('aria-expanded', 'true')
                                        .addClass(settings.openClass)
                                        .filter('.' + settings.panelClass)
                                        .attr('aria-hidden', 'false')
                                        .find(':tabbable:last')
                                        .focus() === 1);
                                }
                            } else if (!isTopNavItem) {
                                found = (tabbables.filter(':lt(' + tabbables.index(target) + '):last').focus().length === 1);
                            }

                            if (!found && window.opera && opera.toString() === "[object Opera]" && (event.ctrlKey || event.metaKey)) {
                                tabbables = $(':tabbable');
                                i = tabbables.index(target);
                                found = ($(':tabbable:lt(' + $(':tabbable').index(target) + '):first').focus().length === 1);
                            }
                            break;
                        case Keyboard.RIGHT:
                            event.preventDefault();
                            if (isTopNavItem) {
                                found = (topnavitems.filter(':gt(' + topnavitems.index(topli) + '):first').find(':tabbable:first').focus().length === 1);
                            } else {
                                if (panelGroups.length && currentPanelGroup.length) {
                                    // if the current panel contains panel groups, and we are able to focus the first tabbable element of the next panel group
                                    found = (panelGroups.filter(':gt(' + panelGroups.index(currentPanelGroup) + '):first').find(':tabbable:first').focus().length === 1);
                                }

                                if (!found) {
                                    found = (topli.find(':tabbable:first').focus().length === 1);
                                }
                            }
                            break;
                        case Keyboard.LEFT:
                            event.preventDefault();
                            if (isTopNavItem) {
                                found = (topnavitems.filter(':lt(' + topnavitems.index(topli) + '):last').find(':tabbable:first').focus().length === 1);
                            } else {
                                if (panelGroups.length && currentPanelGroup.length) {
                                    // if the current panel contains panel groups, and we are able to focus the first tabbable element of the previous panel group
                                    found = (panelGroups.filter(':lt(' + panelGroups.index(currentPanelGroup) + '):last').find(':tabbable:first').focus().length === 1);
                                }

                                if (!found) {
                                    found = (topli.find(':tabbable:first').focus().length === 1);
                                }
                            }
                            break;
                        case Keyboard.TAB:
                            i = tabbables.index(target);
                            if (event.shiftKey && isTopNavItem && target.hasClass(settings.openClass)) {
                                _togglePanel.call(that, event, true);
                                next = topnavitems.filter(':lt(' + topnavitems.index(topli) + '):last');
                                if (next.children('.' + settings.panelClass).length) {
                                    found = next.children()
                                        .attr('aria-expanded', 'true')
                                        .addClass(settings.openClass)
                                        .filter('.' + settings.panelClass)
                                        .attr('aria-hidden', 'false')
                                        .find(':tabbable:last')
                                        .focus();
                                }
                            } else if (event.shiftKey && i > 0) {
                                found = (tabbables.filter(':lt(' + i + '):last').focus().length === 1);
                            } else if (!event.shiftKey && i < tabbables.length - 1) {
                                found = (tabbables.filter(':gt(' + i + '):first').focus().length === 1);
                            } else if (window.opera && opera.toString() === "[object Opera]") {
                                tabbables = $(':tabbable');
                                i = tabbables.index(target);
                                if (event.shiftKey) {
                                    found = ($(':tabbable:lt(' + $(':tabbable').index(target) + '):last').focus().length === 1);
                                } else {
                                    found = ($(':tabbable:gt(' + $(':tabbable').index(target) + '):first').focus().length === 1);
                                }
                            }

                            if (found) {
                                event.preventDefault();
                            }
                            break;
                        case Keyboard.SPACE:
                            if (isTopNavItem) {
                                event.preventDefault();
                                _clickHandler.call(that, event);
                            } else {
                                return true;
                            }
                            break;
                        case Keyboard.ENTER:
                            return true;
                            break;
                        default:
                            // alphanumeric filter
                            clearTimeout(this.keydownTimeoutID);

                            keydownSearchString += newString !== keydownSearchString ? newString : '';

                            if (keydownSearchString.length === 0) {
                                return;
                            }

                            this.keydownTimeoutID = setTimeout(function () {
                                keydownSearchString = '';
                            }, keydownTimeoutDuration);

                            if (isTopNavItem && !target.hasClass(settings.openClass)) {
                                tabbables = tabbables.filter(':not(.' + settings.panelClass + ' :tabbable)');
                            } else {
                                tabbables = topli.find(':tabbable');
                            }

                            if (event.shiftKey) {
                                tabbables = $(tabbables.get()
                                    .reverse());
                            }

                            for (i = 0; i < tabbables.length; i++) {
                                o = tabbables.eq(i);
                                if (o.is(target)) {
                                    start = (keydownSearchString.length === 1) ? i + 1 : i;
                                    break;
                                }
                            }

                            regex = new RegExp('^' + keydownSearchString.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, '\\$&'), 'i');

                            for (i = start; i < tabbables.length; i++) {
                                o = tabbables.eq(i);
                                label = $.trim(o.text());
                                if (regex.test(label)) {
                                    found = true;
                                    o.focus();
                                    break;
                                }
                            }
                            if (!found) {
                                for (i = 0; i < start; i++) {
                                    o = tabbables.eq(i);
                                    label = $.trim(o.text());
                                    if (regex.test(label)) {
                                        o.focus();
                                        break;
                                    }
                                }
                            }
                            break;
                    }
                    that.justFocused = false;
                };



                /* public attributes and methods ------------------------- */
                return {
                    constructor: AccessibleMegaMenu,

                    /**
                     * @lends jQuery.fn.accessibleMegaMenu
                     * @desc Initializes an instance of the accessibleMegaMenu plugins
                     * @memberof jQuery.fn.accessibleMegaMenu
                     * @instance
                     */
                    init: function () {
                    console.log('init');
                        var settings = this.settings,
                            nav = $(this.element),
                            menu = nav.children().first(),
                            topnavitems = menu.children();
                        this.start(settings, nav, menu, topnavitems);
                    },

                    start: function(settings, nav, menu, topnavitems) {
                        var that = this;
                        this.settings = settings;
                        this.menu = menu;
                        this.topnavitems = topnavitems;

                        //nav.attr("role", "navigation");
                        menu.addClass(settings.menuClass).attr('role', 'menubar').attr('aria-label','Megamenu');
                        topnavitems.each(function (i, topnavitem) {
                            var topnavitemlink, topnavitempanel;
                            topnavitem = $(topnavitem);
                            topnavitem.addClass(settings.topNavItemClass);
                            topnavitemlink = topnavitem.find(":tabbable:first");
                            topnavitempanel = topnavitem.children(":not(:tabbable):last");
                            _addUniqueId.call(that, topnavitemlink);
                            if (topnavitempanel.length) {
                                _addUniqueId.call(that, topnavitempanel);
                                topnavitemlink.attr({
                                    "aria-haspopup": true,
                                    "role": "menuitem",
                                    "tabindex": -1,
                                    "aria-controls": topnavitempanel.attr("id"),
                                    "aria-expanded": false
                                });

                                topnavitempanel.attr({
                                    "role": "menu", // was role=region
                                    "aria-expanded": false,
                                    "aria-hidden": true,
                                    "aria-label": topnavitemlink.text()
                                })
                                    .addClass(settings.panelClass)
                                    .not("[aria-labelledby]")
                                    .attr("aria-labelledby", topnavitemlink.attr("id"));
                            }
                        });

                        this.panels = menu.find("." + settings.panelClass);

                        menu.on("focusin.accessible-megamenu", ":focusable, ." + settings.panelClass, $.proxy(_focusInHandler, this))
                            .on("focusout.accessible-megamenu", ":focusable, ." + settings.panelClass, $.proxy(_focusOutHandler, this))
                            .on("keydown.accessible-megamenu", $.proxy(_keyDownHandler, this))
                            .on("mouseover.accessible-megamenu", $.proxy(_mouseOverHandler, this))
                            .on("mouseout.accessible-megamenu", $.proxy(_mouseOutHandler, this))
                            .on("mousedown.accessible-megamenu", $.proxy(_mouseDownHandler, this));

                        if (isTouch) {
                            menu.on("touchstart.accessible-megamenu",  $.proxy(_clickHandler, this));
                        }

                        menu.find("hr").attr("role", "separator");

                        if ($(document.activeElement).closest(menu).length) {
                            $(document.activeElement).trigger("focusin.accessible-megamenu");
                        }
                    },
                };




            }());

            $.fn[pluginName] = function (options) {
                return this.each(function () {
                    if (!$.data(this, "plugin_" + pluginName)) {
                        $.data(this, "plugin_" + pluginName, new $.fn[pluginName].AccessibleMegaMenu(this, options));
                    }
                });
            };

            $.fn[pluginName].AccessibleMegaMenu = AccessibleMegaMenu;

        }(jQuery, window, document));
    </script>

    <script>
        // Initialize the plugin
        $('header > div').accessibleMegaMenu();

    </script>


</head>

<body>
<header>
    <div role="menubar">
        <ul role="menu">
            <li role="menu-item">
                <a href="http://google.com/?q=parent1">Parent 1</a>
                <ul>
                    <li role="menu-item">
                        <a href="http://google.com/?q=child1">Child 1</a>
                        <ul>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild1">Subchild 1</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild2">Subchild 2</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild3">Subchild 3</a>
                            </li>
                        </ul>
                    </li>
                    <li role="menu-item">
                        <a href="http://google.com/?q=child2">Child 2</a>
                        <ul>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild1">Subchild 1</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild2">Subchild 2</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild3">Subchild 3</a>
                            </li>
                        </ul>
                    </li>
                    <li role="menu-item">
                        <a href="http://google.com/?q=child3">Child 3</a>
                        <ul>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild1">Subchild 1</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild2">Subchild 2</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild3">Subchild 3</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </li>
        </ul>
        <ul role="menu">
            <li role="menu-item">
                <a href="http://google.com/?q=parent2">Parent 2</a>
                <ul>
                    <li role="menu-item">
                        <a href="http://google.com/?q=child1">Child 1</a>
                        <ul>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild1">Subchild 1</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild2">Subchild 2</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild3">Subchild 3</a>
                            </li>
                        </ul>
                    </li>
                    <li role="menu-item">
                        <a href="http://google.com/?q=child2">Child 2</a>
                        <ul>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild1">Subchild 1</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild2">Subchild 2</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild3">Subchild 3</a>
                            </li>
                        </ul>
                    </li>
                    <li role="menu-item">
                        <a href="http://google.com/?q=child3">Child 3</a>
                        <ul>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild1">Subchild 1</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild2">Subchild 2</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild3">Subchild 3</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </li>
        </ul>
        <ul role="menu">
            <li role="menu-item">
                <a href="http://google.com/?q=parent3">Parent 1</a>
                <ul>
                    <li role="menu-item">
                        <a href="http://google.com/?q=child1">Child 1</a>
                        <ul>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild1">Subchild 1</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild2">Subchild 2</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild3">Subchild 3</a>
                            </li>
                        </ul>
                    </li>
                    <li role="menu-item">
                        <a href="http://google.com/?q=child2">Child 2</a>
                        <ul>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild1">Subchild 1</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild2">Subchild 2</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild3">Subchild 3</a>
                            </li>
                        </ul>
                    </li>
                    <li role="menu-item">
                        <a href="http://google.com/?q=child3">Child 3</a>
                        <ul>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild1">Subchild 1</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild2">Subchild 2</a>
                            </li>
                            <li role="menu-item">
                                <a href="http://google.com/?q=subchild3">Subchild 3</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
</header>
<main>
    <p>Main content.</p>
</main>
<footer>
    <p>Footer content.</p>
</footer>
</body>
</html>